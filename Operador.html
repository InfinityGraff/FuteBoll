<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Operador - Placar</title>
    <link  href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link  href="./MyBiblioteca/CSSBiblioteca.css" rel="stylesheet">
    <script src="./MyBiblioteca/PreScript.js"></script>
    <script src="./MyBiblioteca/PrepDrop.js"></script>

    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script> // Base de Dados
      const SUPABASE_URL      = "https://adxigvfxtafvlmpvwwvb.supabase.co"
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkeGlndmZ4dGFmdmxtcHZ3d3ZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1Njc1NTEsImV4cCI6MjA2NzE0MzU1MX0.wc90qDuSNhtolJBd4qLEux3xCwJwPuTTFb3gZMKUBYU"
      const supabase          =  window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY)
      const BASE_URL          = `https://adxigvfxtafvlmpvwwvb.supabase.co/storage/v1/object/public/Jogo/Imgs`
    </script>
</head>

<style>
  *     {margin:0;padding:0;font-family:Montserrat,Arial}
  body  {background:#f0f2f5;color:#333;padding:20px}
  h1    {font-size:2.5rem;margin-bottom:20px;color:#636363 ; font-weight:700;font-family:Montserrat,Arial}
  .Times{display:flex ; align-items:start; gap:12px; margin: 10px;}
  #Tela{top: 20px; right: 30px; width: 20px; height: 20px;}

  label {display:block; font-weight:bold}
  input,select             {width:200px; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:1rem; transition:border 0.2s, box-shadow 0.2s; }
  input:focus,select:focus {border-color:#4a90e2; box-shadow:0 0 5px #4a90e280; outline:none}

  input[type="checkbox"],input[type="radio"]{width: auto}
  button      {padding:8px 10px;font-size:1.2rem; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:700}
  .Drop       { border:2px dashed #a1c2d8; border-radius:10px; text-align:center; background:#ffffff1a; cursor:pointer; position:relative; overflow:hidden;  -height:60px}
  .Drop:hover { background:#63a6dd33}.Drop.hover { background:#63a6dd33}
  .Drop img   { width:auto ; height:80px; border-radius:10px}
  
  .Nome{width: 100%;} /*BOTEI PRA AJUSTAR PRA VER*/
  .Drop{width: 100%;} /*BOTEI PRA AJUSTAR PRA VER*/
  .T_A,.T_B   {background:#fff;box-shadow:0 2px 10px #0000001a;padding:20px;width:50%}

  .botoes           {margin-top:20px ; margin-bottom:20px; gap:5px; opacity:0.2;pointer-events: none}.botoes.Atv{opacity:1;pointer-events: auto}
  .DivTime,.DivStars{margin-top:10px                     ; gap:7px ;opacity:0.2;pointer-events: none}.DivTime.Atv,.DivStars.Atv{opacity:1;pointer-events: auto;}
  
  header{width:100%; flex-wrap: nowrap !important; overflow: hidden; max-height: 172px; gap: 8px;} header > *{transition: all 0.4s ease}
  header .Plyr { width: 0%;opacity: 0;}header .inpt,header .Gols { width: 50%}
  header.Atv > * { width:33%;opacity: 1}
  .Disab {cursor: not-allowed;opacity: 0.5}

  .C_Gol      {background:#28a745}.C_Amr      {background:#ffc107;color:#3d2d00}.C_Red      {background:#dc3545}.C_Flt,.C_Sub,.C_Out                 {background:#6c757d}.Blu      {background:#357ABD}
  .C_Gol:hover{background:#218838}.C_Amr:hover{background:#e0ac00;color:#3d2d00}.C_Red:hover{background:#c82333}.C_Flt:hover,.C_Sub:hover.C_Out:hover{background:#5a6268}.Blu:hover{background:#2c639d}
  .C_-Gol      {background:#c82333}

  .Gols{font-size:80px;font-weight:900;color:#007bff}
  .hist{width:100%;border-top:1px solid #ddd;margin-top:5px;padding-top:5px;font-size:13px;text-align:left;overflow-y:scroll;height: 0px;opacity: 0;transition: all 0.4s ease}
  .hist.Atv{height:150px;opacity: 1;}
  .hist table{width:100%;}
  .hist table td {cursor:default}
  .hist table :is(td,th):nth-child(6){display:none}
  
  textarea{width:100%;height:139px;resize:none;border:1.5px solid #ccc;border-radius:8px;outline:none;resize:vertical;font-size:14px;line-height:1.4;color:#333;background:#fafafa;box-shadow:0 1px 3px #4a91e21f;transition:all 0.25s ease;text-align:left;overflow-y:auto;}
  textarea:focus{border-color:#4a90e2;background:#fff;box-shadow:0 0 0 3px #4a91e248;}
  textarea::placeholder{color: #999;font-style: italic;opacity: 1}

  /*Particular*/
  .MyAlert{background:#28a745;color:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px #0000004d}
</style>

<script> // Base
  const Tempos = {"1¬∫ Tempo":"45:00","2¬∫ Tempo":"45:00","Prorroga√ß√£o":"30:00","Acr√©scimos":"05:00","P√™naltis":"00:00","Encerrado":"00:00"};
  const DbrevJogo={
        Gol:`‚öΩÔ∏è Gol`,
     '-Gol':`‚ùå‚öΩ Gol Impedido `,
        Amr:`üü® Cart√£o Amarelo`,
        Red:`üü• Cart√£o Vermelho `,
        Flt:`‚ùå Falta`,
        Sub:`üîÑ Subistitui√ß√£o`,
        Cnf:`Aguardando`,
        Ply:`Jogo Iniciado`,
        Stp:`Intervalo`,
        End:`Jogo Encerrado`,
  }
  const histo = ['Dia','Hora','Evento','Minuto','Time','Ev']
</script>

<body class="Cl">
  <h1>Operador do Placar</h1> <a href="file:///C:/Users/allan/Documents/GitHub/FuteBoll/Tela.html" target="_blank"><img id="Tela" class="Abslt" src="./Imgs/Tela.png"></a>

  <div class="Ct">Nomes de Jogadores:
    <label><input class="Player" type="radio" name="jogadores" value="S" onchange="ATVtrue($$('header'),this.value=='S')">Sim</label>
    <label><input class="Player" type="radio" name="jogadores" value="N" onchange="ATVtrue($$('header'),this.value=='S')">N√£o</label>
  </div>
  <div class="Ct">Hist√≥rico de Eventos:
    <label><input class="Events" type="radio" name="eventos" value="S" onchange="ATVtrue($$('.hist' ),this.value=='S')">Sim</label>
    <label><input class="Events" type="radio" name="eventos" value="N" onchange="ATVtrue($$('.hist' ),this.value=='S')">N√£o</label>
  </div>

  <div class="w100 Times">
    <div class="Cl T_A rd">
      <header class="Ct">
        <div class="Plyr Cl"><textarea spellcheck="false" onload="TxtArea(this)"></textarea></div>
        <div class="inpt Cl">
          <div class="Drop Ct" onload="PrepDrop(this,'Time_A')"></div>
          <label>Time A:</label><input class="Nome" placeholder="Nome do Time A...">
        </div>
        <div class="Gols">0</div>
      </header>
      <div class="botoes Ct" onload="LoadBtns('A',this)"></div>
      <div class="hist" id="histA"><div>Hist√≥rico de Eventos</div><table onload="TblHist(this)"></table></div>
    </div>

    <div class="Cl T_B rd">
      <header class="Ct">
        <div class="Gols">0</div>
        <div class="inpt Cl">
          <div class="Drop Ct" onload="PrepDrop(this,'Time_B')"></div>
          <label>Time B:</label><input class="Nome" placeholder="Nome do Time B...">
        </div>
        <div class="Plyr Cl"><textarea spellcheck="false" onload="TxtArea(this)"></textarea></div>
      </header>
      <div class="botoes Ct" onload="LoadBtns('B',this)"></div>
      <div class="hist" id="histB"><div>Hist√≥rico de Eventos</div><table onload="TblHist(this)"></table></div>
    </div>
  </div>

  <div id="Config"><button class="C_Out Disab" onclick="Requered()">Configurar Jogo üîí</button></div>

  <div class="Ct DivTime">
    <div class="Start2"><label>Tempo:  </label><select id="Tempo" onchange="ReadMin(this)"></select><script>load_Opts($('#Tempo'),["1¬∫ Tempo","2¬∫ Tempo","Prorroga√ß√£o","Acr√©scimos","P√™naltis","Encerrado"])</script></div>
    <div class="Start2"><label>Minutos:</label><input id="Minutos" placeholder="00:00" maxlength="5" oninput="MaskMin(this);AlteraTime(true)" value="45:00"></div>
    <button id="ReadMiiin" class="Blu none" style="margin-left: 7px;" onclick="AlteraTime(false)">Altera Tempo</button>
  </div>

  <div class="DivStars Ct">
    <div id="Timer"><p>1¬∞ Tempo</p><a>01:00</a></div>
    <button id="BtnPlay" class="C_Gol Hov"      onclick="BtnPlays(Timer($('#Timer a'),'play',300))">Iniciar Jogo </button>
    <button id="BtnEnd"  class="C_Red Hov none" onclick="BtnPlays(Timer($('#Timer a'),'end' ,300))">Encerrar Jogo</button>
    <script>
      const BtnPlays=r=>{
        if(!r) return
        if(r.acao==='play' ){Inn(BtnPlay,'Pausar' ) ; Trc(BtnPlay,'C_Amr','C_Gol') ; Rmv_N(BtnEnd) ; AddEvento('','Ply','Ply') ; ATV($$('.botoes'))}
        if(r.acao==='pause'){Inn(BtnPlay,'Retomar') ; Trc(BtnPlay,'C_Gol','C_Amr') ; Rmv_N(BtnEnd) ; AddEvento('','Stp','Stp') ; DTV($$('.botoes'))}
        if(r.acao==='end'  ){Inn(BtnPlay,'Iniciar') ; Trc(BtnPlay,'C_Gol','C_Amr') ; Add_N(BtnEnd) ; AddEvento('','End','End') ; DTV($$('.botoes'))}
      }
    </script>
  </div>
</body>

<script> // Campos Obrigat√≥rios
  let Requireds = false
  document.oninput=()=>{
    const btn = $('#Config')
    const valJog = $('input[name="jogadores"]:checked')?.value
    const valEvt = $('input[name="eventos"]:checked'  )?.value
    const ativos = !(Vll('.T_A .Nome').trim()=='' || Vll('.T_B .Nome').trim()=='') && (valJog && valEvt)
    if(Requireds){Requered()}
    if(ativos){Inn(btn,`<button class="Blu"         onclick="Configurar()">Configurar Jogo ‚úîÔ∏è</button>`)}
    else      {Inn(btn,`<button class="C_Out Disab" onclick="Requered()"  >Configurar Jogo üîí</button>`)}
  }

  function Requered(){
    ['Player','Events'].forEach(c=>$$(`.${c}`).forEach(r=>Pai(r).style.color=$$(`.${c}:checked`).length?'black':'red'))
    $$('.Nome').forEach(e=>e.value.trim() ? Rmv(e,'error') : Add(e,'error'))
    Inn($('#Config button'),'Falta Campos Obrigat√≥rios')
    Requireds=true
  }
</script>

<script>
  let Zerado = false
  let Placar = {A:0,B:0}
  const ReadMin=Eu=>Vll(Minutos,Tempos[Vll(Eu)])
  const TblHist=Eu=>Inn(Eu,`<thead><tr>${histo.map(e=>`<th>${e}</th>`).join('')}<th>-</th></tr></thead><tbody></tbody>`)
  const TxtArea=Eu=>Eu.placeholder =  "10 - Nome\n05 - Nome\n..."
  const NewLinn=Ar=>`<tr>${Ar.map(e=>`<td class="noslt">${e}</td>`).join('')}<td class="PT" onclick="_tr(this).remove()">‚ùå</td></tr>`
  const CnvHist=AB=>$$(`#hist${AB} table tbody tr`).map(tr=>histo.reduce((o,k,x)=>(o[k]=$$('td',tr)[x]?.textContent.trim()||'',o),{}))
  const Cfgrado=()=>ATV($$('.DivStars,.DivTime')) ; Inn($('#Config button'),'Reconfigurar Jogo üîÑ')

  function LoadBtns(AB,Eu){
    const Typ=[{t:"Gol",l:"Gol"},{t:"-Gol",l:"-Gol"},{t:"Amr",l:"Amarelo"},{t:"Red",l:"Vermelho"},{t:"Flt",l:"Falta"},{t:"Sub",l:"Substitui√ß√£o"}]
    Inn(Eu,Typ.map(b=>`<button class="C_${b.t} Hov" onclick="AddEvento('${AB}','${b.t}')">${b.l}</button>`).join(''))
  }

  async function UPPImg(file,nome){ // Supabase
    const path = `Imgs/${nome}`
    const {error} = await supabase.storage.from('Jogo').upload(path,file,{upsert:true})
       if (error)  return alert('‚ùå Erro ao enviar imagem'),null
    return supabase.storage.from('Jogo').getPublicUrl(path).publicUrl
  }

  async function Configurar(SB){
    if(!SB){if (!confirm('Deseja realmente configurar o jogo?')) return}
    const obj = {
      Tim_A:   Vll('.T_A .Nome'),Tim_B:   Vll('.T_B .Nome'),
      Gol_A:  +Inn('.T_A .Gols'),Gol_B:  +Inn('.T_B .Gols'),
      Img_A:  Nm($('.T_A img') ),Img_B:  Nm($('.T_B img') ),
      Tempo:  Vll('#Tempo'),Ev:['Cnf'],Stts:'Iniciar'
    }
    const NomeA = Nm($('.T_A .Drop img')) ; const F_A = VarDropImg[Nm($('.T_A .Drop img'))] // Pega o Arquivo Files
    const NomeB = Nm($('.T_B .Drop img')) ; const F_B = VarDropImg[Nm($('.T_B .Drop img'))] // Pega o Arquivo Files
    UPPImg(F_A,NomeA) ; UPPImg(F_B,NomeB) ; LOG('Imagens Foram Upado',NomeA,NomeB)
    
    LOG(Zerado)
    if(Zerado){
      const {data,error}=await supabase.from('placar').insert([obj]).select().maybeSingle()
      if(error) ERR(error)
      else MyAlert('‚úÖ Jogo Configurado!'), console.log('Nova linha:',data)
    }else{
      let {data:Ultima,error}=await supabase.from('placar').select('*').order('id',{ascending:false}).limit(1).maybeSingle()
      if(error) return ERR(error)
      if(!Ultima) return ERR('Nenhuma linha encontrada')
      const {error:updateErr}=await supabase.from('placar').update(obj).eq('id',Ultima.id)
      if(updateErr) return ERR(updateErr)
      MyAlert('‚úÖ Jogo Configurado!'); console.log('Linha atualizada:',Ultima)
    }
    Cfgrado()
  }

  async function AddEvento(AB,ev,Stts){
    const AddHist=(ab)=>$(`#hist${ab} table`).innerHTML+=NewLinn([HOJE(),AGORA2(),DbrevJogo[ev],Inn($('#Timer a')),AB==''?'-':Vll($(`.T_${ab} .Nome`)),ev])
    if(AB==''){AddHist('A');AddHist('B')}else{AddHist(AB)}
    if(ev=='Gol' ){Placar[AB]++ ; Inn($(`.T_${AB} .Gols`),Placar[AB])}
    if(ev=='-Gol'){Placar[AB]-- ; Inn($(`.T_${AB} .Gols`),Placar[AB])}
    const obj = {Gol_A:+Inn('.T_A .Gols'),Gol_B:+Inn('.T_B .Gols'),Tempo:Vll('#Tempo'),Ev:[ev,AB],Hist_A:CnvHist('A'),Hist_B:CnvHist('B'),...(Stts!==undefined && {Stts})}
    const {error} = await supabase.from('placar').update(obj).eq('id',1);if(error){ERR(error)}else{MyAlert('‚úÖ Placar Atualizado!')}
  }
  
  function AlteraTime(Tipo){
    if(Tipo){Inn(ReadMiiin,"Altera Tempo");Rmv_N(ReadMiiin)}
    else{Inn(ReadMiiin,"Tempo Atualizado");setTimeout(()=>Add_N(ReadMiiin),1000)}
    AddEvento('','ReadTempo')
  }

  function Pass(Pss){
    let Inpt = prompt("Digite a senha para continuar:")
    while (Inpt === null || Inpt !== Pss || Inpt !== 12) {Inpt = prompt("Senha incorreta. Tente novamente:")};return true
  }

  async function carregar(){
    let {data:Ulti,error} = await supabase.from('placar').select('*').order('id',{ascending:false}).limit(1).maybeSingle()
    if(error){ERR("Erro ao buscar √∫ltimo registro:", error)}

    const GetSB=e=>{ //Veio do SUPABASE
      Vll($('.T_A .Nome'),e.Tim_A) ; Vll($('.T_B .Nome'),e.Tim_B)
      Inn($('.T_A .Gols'),e.Gol_A) ; Inn($('.T_B .Gols'),e.Gol_B)
      Placar.A=e.Gol_A ; Placar.B=e.Gol_B
      Inn($('.T_A .Drop a'),`<img src="${BASE_URL}/${e.Img_A}?v=${Date.now()}" name="${e.Img_A}">`) // Inseir Imagem
      Inn($('.T_B .Drop a'),`<img src="${BASE_URL}/${e.Img_B}?v=${Date.now()}" name="${e.Img_B}">`) // Inseir Imagem
      if(!e.Hist_A || !e.Hist_B){return}else{
        Inn($(`#histA table tbody`),e.Hist_A.map(s=>NewLinn([s.Dia,s.Hora,s.Evento,s.Minuto,s.Time,s.Ev])).join(''))
        Inn($(`#histB table tbody`),e.Hist_B.map(s=>NewLinn([s.Dia,s.Hora,s.Evento,s.Minuto,s.Time,s.Ev])).join(''))
      }
    }

    Ulti.Hist_A.filter(e=>e.Minuto)

    if(Ulti){
      if(Ulti.Stts=='Iniciar'){GetSB(Ulti);Configurar('SB')} // Importa dados e Configura!
      if(Ulti.Stts=='Ply'){GetSB(Ulti);Cfgrado()}            // deixa Rodando
      if(Ulti.Stts=='Stp'){GetSB(Ulti);Cfgrado()}            // deixa em Pausa
      if(Ulti.Stts=='End'){Zerado=true}                      // Prepara-se pra Inserir Nova Linha
    }
  }
  Onloads('body')
  carregar() 
  //if (Pass('123')){carregar()} // fazer 2 Senhas uma pra mim, uma pra os cara de l√°
  // Adicionar Hist√≥rico de Imagens
</script>

</html>